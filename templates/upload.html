<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Upload Notes</title>
		<link rel="stylesheet" href="../static/dist/output.css" />
		<!-- No external JS needed in head, all scripts are inline or loaded at end of body -->
	</head>

	<body class="bg-base-200 min-h-screen p-2 sm:p-4 transition-colors duration-300">
		{% include '_navbar.html' %}
		<div class="card w-full max-w-lg mx-auto bg-base-100 shadow-2xl border border-base-300 rounded-2xl mt-4">
			<div class="card-body p-6 sm:p-8">
				<div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-8">
					<h2 class="text-3xl font-bold text-primary flex items-center gap-2 justify-center w-full text-center">
						<svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
						</svg>
						Upload Notes
					</h2>
				</div>
				{% with messages = get_flashed_messages() %} {% if messages %}
				<div class="space-y-2 mb-4">
					{% for message in messages %}
					<div class="alert alert-success flex items-center gap-2">
						<svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
						</svg>
						<span>{{ message }}</span>
					</div>
					{% endfor %}
				</div>
				{% endif %} {% endwith %} {% if user_id %}
				<div>
					<div class="tabs tabs-boxed mb-6 flex flex-row justify-center gap-2">
						<button type="button" id="tab-file" class="tab tab-active !rounded-lg !px-4 !py-2" onclick="showTab('file')">
							<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
							</svg>
							File Upload
						</button>
						<button type="button" id="tab-link" class="tab !rounded-lg !px-4 !py-2" onclick="showTab('link')">
							<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.102m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
							</svg>
							Link Upload
						</button>
						<button type="button" id="tab-wallpaper" class="tab !rounded-lg !px-4 !py-2" onclick="showTab('wallpaper')">
							<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
								<path stroke-linecap="round" stroke-linejoin="round" d="m2.25 15.75 5.159-5.159a2.25 2.25 0 0 1 3.182 0l5.159 5.159m-1.5-1.5 1.409-1.409a2.25 2.25 0 0 1 3.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 0 0 1.5-1.5V6a1.5 1.5 0 0 0-1.5-1.5H3.75A1.5 1.5 0 0 0 2.25 6v12a1.5 1.5 0 0 0 1.5 1.5Zm10.5-11.25h.008v.008h-.008V8.25Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Z" />
							</svg>
							Wallpaper
						</button>
						<button type="button" id="tab-instagram" class="tab !rounded-lg !px-4 !py-2" onclick="showTab('instagram')">
							<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7.75 2h8.5A5.75 5.75 0 0 1 22 7.75v8.5A5.75 5.75 0 0 1 16.25 22h-8.5A5.75 5.75 0 0 1 2 16.25v-8.5A5.75 5.75 0 0 1 7.75 2z" />
								<circle cx="12" cy="12" r="3.5" />
								<circle cx="17.5" cy="6.5" r="1" />
							</svg>
							Instagram
						</button>
					</div>
					<form method="post" enctype="multipart/form-data" class="space-y-6" id="form-file">
						<div>
							<label class="block font-semibold mb-1">Subject</label>
							<select name="subject" required class="select select-bordered w-full rounded-lg">
								<option value="" disabled selected>Select a subject</option>
								{% for subject in subjects %}
								<option value="{{ subject }}">{{ subject.title() }}</option>
								{% endfor %}
							</select>
						</div>
						<div id="title-field">
							<label class="block font-semibold mb-1">Title</label>
							<input id="title-input" type="text" name="title" placeholder="Enter a custom title" class="input input-bordered w-full rounded-lg" />
						</div>
						<div>
							<label class="block font-semibold mb-1">File(s)</label>
							<input type="file" name="file" id="file-input" class="file-input file-input-bordered w-full rounded-lg" multiple />
							<span class="text-xs text-gray-400 block mt-1">You can select multiple files. If you do, custom title will be ignored and file name will be used as title.</span>
						</div>
						<input type="hidden" name="upload_type" value="file" />
						<button type="submit" id="upload-btn" class="btn btn-primary w-full rounded-lg shadow">Upload</button>
						<div class="w-full mt-2">
							<div id="progress-container" class="hidden">
								<div class="alert alert-info flex flex-col items-center gap-2 py-3">
									<progress id="progress-bar" class="progress progress-primary w-full mb-2" value="0" max="100"></progress>
									<div id="progress-text" class="text-sm font-medium"></div>
								</div>
							</div>
						</div>
					</form>
					<script>
						document.getElementById("file-input").addEventListener("change", function (e) {
							const titleField = document.getElementById("title-field");
							if (this.files.length > 1) {
								titleField.style.display = "none";
							} else {
								titleField.style.display = "";
							}
						});

						const fileInput = document.getElementById("file-input");
						const titleField = document.getElementById("title-field");
						const titleInput = document.getElementById("title-input");
						fileInput.addEventListener("change", function (e) {
							if (this.files.length > 1) {
								if (titleField) titleField.style.display = "none";
								if (titleInput) {
									titleInput.removeAttribute("required");
									titleInput.disabled = true;
									titleInput.value = "";
								}
							} else {
								if (titleField) titleField.style.display = "";
								if (titleInput) {
									titleInput.setAttribute("required", "required");
									titleInput.disabled = false;
								}
							}
						});

						document.getElementById("form-file").addEventListener("submit", function (e) {
							if (fileInput.files.length === 0) return;

							if (fileInput.files.length > 1 && titleInput) {
								titleInput.removeAttribute("required");
								titleInput.value = "";
							}
							e.preventDefault();
							const form = this;
							const formData = new FormData(form);
							const xhr = new XMLHttpRequest();
							const progressBar = document.getElementById("progress-bar");
							const progressContainer = document.getElementById("progress-container");
							const progressText = document.getElementById("progress-text");
							const uploadBtn = document.getElementById("upload-btn");
							progressContainer.classList.remove("hidden");
							progressBar.value = 0;
							progressText.textContent = "";
							uploadBtn.disabled = true;

							progressText.className = "text-sm font-medium";
							progressContainer.querySelector(".alert").classList.remove("alert-success", "alert-error");
							progressContainer.querySelector(".alert").classList.add("alert-info");

							xhr.upload.addEventListener("progress", function (e) {
								if (e.lengthComputable) {
									const percent = Math.round((e.loaded / e.total) * 100);
									progressBar.value = percent;
									progressText.textContent = percent + "% uploaded";
								}
							});
							xhr.onreadystatechange = function () {
								if (xhr.readyState === XMLHttpRequest.DONE) {
									uploadBtn.disabled = false;
									if (xhr.status === 200) {
										progressBar.value = 100;
										progressText.textContent = "Upload complete!";
										progressContainer.querySelector(".alert").classList.remove("alert-info", "alert-error");
										progressContainer.querySelector(".alert").classList.add("alert-success");
										setTimeout(() => {
											progressContainer.classList.add("hidden");
											progressText.textContent = "";
											window.location.reload();
										}, 800);
									} else {
										progressText.textContent = "Upload failed.";
										progressContainer.querySelector(".alert").classList.remove("alert-info", "alert-success");
										progressContainer.querySelector(".alert").classList.add("alert-error");
										setTimeout(() => {
											progressContainer.classList.add("hidden");
											progressText.textContent = "";
										}, 2000);
									}
								}
							};
							xhr.open("POST", form.action || window.location.pathname);
							xhr.send(formData);
						});
					</script>
					<form method="post" class="space-y-4 hidden" id="form-link">
						<div>
							<label class="block">Subject</label>
							<select name="subject" required class="select select-bordered w-full">
								<option value="" disabled selected>Select A subject</option>
								{% for subject in subjects %}
								<option value="{{ subject }}">{{ subject.title() }}</option>
								{% endfor %}
							</select>
						</div>
						<div>
							<label class="block">Link</label>
							<input type="url" name="link" placeholder="https://example.com" class="input input-bordered w-full" required />
						</div>
						<input type="hidden" name="upload_type" value="link" />
						<button type="submit" class="btn btn-primary w-full">Upload</button>
					</form>
					<form method="post" enctype="multipart/form-data" action="/wallpapers" class="space-y-4 hidden" id="form-wallpaper">
						<div>
							<label class="block font-semibold mb-1">Wallpaper(s)</label>
							<input type="file" name="wallpaper" id="wallpaper-input" class="file-input file-input-bordered w-full rounded-lg" multiple accept="image/*" required />
						</div>
						<div>
							<label class="block font-semibold mb-1">Tags</label>
							<select name="wallpaper_tag" id="wallpaper-tag-select" class="select select-bordered w-full rounded-lg" required>
								<option value="" disabled selected>Select a tag</option>
								<option value="AI">AI</option>
								<option value="Anime">Anime</option>
								<option value="Nature">Nature</option>
								<option value="Abstract">Abstract</option>
								<option value="Minimal">Minimal</option>
								<option value="Space">Space</option>
								<option value="City">City</option>
								<option value="Other">Other</option>
							</select>
							<span class="text-xs text-gray-400 block mt-1">Choose the main tag for the wallpaper(s).</span>
						</div>
						<button type="submit" class="btn btn-primary w-full">Upload Wallpaper(s)</button>
					</form>
					<form method="post" action="/uploads/instagram" class="space-y-4 hidden" id="form-instagram">
						<div>
							<label class="block font-semibold mb-1">Instagram Post URL</label>
							<input type="url" name="post_url" placeholder="https://www.instagram.com/p/xxxxxxx/" class="input input-bordered w-full rounded-lg" required />
							<span class="text-xs text-gray-400 block mt-1">Paste the Instagram post link (must be public or accessible).</span>
						</div>
						<div>
							<label class="block font-semibold mb-1">Tags</label>
							<select name="wallpaper_tag" class="select select-bordered w-full rounded-lg" required>
								<option value="" disabled selected>Select a tag</option>
								<option value="AI">AI</option>
								<option value="Anime">Anime</option>
								<option value="Nature">Nature</option>
								<option value="Abstract">Abstract</option>
								<option value="Minimal">Minimal</option>
								<option value="Space">Space</option>
								<option value="City">City</option>
								<option value="Other">Other</option>
							</select>
						</div>
						<button type="submit" class="btn btn-primary w-full">Upload From Instagram</button>
					</form>
				</div>
				<script>
					function showTab(type) {
						document.getElementById("form-file").classList.toggle("hidden", type !== "file");
						document.getElementById("form-link").classList.toggle("hidden", type !== "link");
						document.getElementById("form-wallpaper").classList.toggle("hidden", type !== "wallpaper");
						document.getElementById("form-instagram").classList.toggle("hidden", type !== "instagram");

						document.getElementById("tab-file").classList.toggle("tab-active", type === "file");
						document.getElementById("tab-link").classList.toggle("tab-active", type === "link");
						document.getElementById("tab-wallpaper").classList.toggle("tab-active", type === "wallpaper");
						document.getElementById("tab-instagram").classList.toggle("tab-active", type === "instagram");
					}

					showTab("file");
				</script>
				{% else %}
				<div class="text-center">
					<div class="mb-4">
						<div class="text-lg font-medium mb-2">Please login to upload notes</div>
						<p class="text-sm opacity-60">Connect with Discord to start uploading and managing your notes</p>
					</div>
					<a href="/login" class="btn btn-primary">
						<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="currentColor" viewBox="0 0 24 24">
							<path
								d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0 12.64 12.64 0 0 0-.617-1.25.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057 19.9 19.9 0 0 0 5.993 3.03.078.078 0 0 0 .084-.028 14.09 14.09 0 0 0 1.226-1.994.076.076 0 0 0-.041-.106 13.107 13.107 0 0 1-1.872-.892.077.077 0 0 1-.008-.128 10.2 10.2 0 0 0 .372-.292.074.074 0 0 1 .077-.010c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.193.373.292a.077.077 0 0 1-.006.127 12.299 12.299 0 0 1-1.873.892.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028 19.839 19.839 0 0 0 6.002-3.03.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.956-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.955-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.946 2.418-2.157 2.418Z"
							/>
						</svg>
						Login With Discord
					</a>
					{% endif %}
				</div>
			</div>
		</div>
	</body>
</html>
